var app=angular.module("app",["ui.bootstrap","ngSanitize"]);app.config(function(b){b.html5Mode(true)});app.filter("FShow",function(){return function(b){if(b!=undefined){var c=[];for(var d=0;d<b.length;d++){if(b[d].show===true){c.push(b[d])}}return c}}});app.filter("FNotShow",function(){return function(b){if(b!=undefined){var c=[];for(var d=0;d<b.length;d++){if(b[d].show===false){c.push(b[d])}}return c}}});app.filter("FSelected",function(){return function(b){if(b!=undefined){var c=[];for(var d=0;d<b.length;d++){if((b[d].show===true)&&(b[d].quantite>0)){c.push(b[d])}}return c}}});app.filter("FChecked",function(){return function(b){if(b!=undefined){var c=[];for(var d=0;d<b.length;d++){if((b[d].show===true)&&(b[d].quantite>0)&&(b[d].checked)){c.push(b[d])}}return c}}});app.filter("FArticles",function(){return function(b){if(b!=undefined){var d=[];for(var e=0;e<b.length;e++){for(var c=0;c<b[e].articles.length;c++){d.push(b[e].articles[c])}}return d}}});app.filter("customDate",function(b){var c=["janvier","fÃ©vrier","mars","avril","mai","juin"];return function(f){var h=new Date(f.replace(/-/gi,"/"));var e=new Date();if(b("date")(e,"dd/MM/yyyy")==b("date")(h,"dd/MM/yyyy")){return"aujourd'hui "+b("date")(h,"HH:mm")}else{var g=c[b("date")(h,"MM")-1];if(b("date")(e,"yyyy")==b("date")(h,"yyyy")){return b("date")(h,"dd ")+g+b("date")(h," HH:mm")}else{return b("date")(h,"dd ")+g+b("date")(h," yyyy HH:mm")}}}});function ListeCtrl(b,f,e,d){b.OpenListe=mescourses.slug;b.query="";b.currentList={name:"chargement...",slug:"mes courses"};b.listemode="edit";b.lightbox=null;b.status=null;b.organize=false;b.savemenu=false;b.loadmenu=false;var c=function(j,g,i){var h=false;angular.forEach(j,function(l,k){if(h===false){if(l[g]===i){h=k}}});return h};b.toCompressed=function(){var g=[];angular.forEach(b.liste,function(i,h){var j={n:i.name,c:i.color,p:i.position,a:[]};angular.forEach(i.articles,function(m,k){var l={n:m.name};if(m.quantite>0){l.v=m.quantite}if(m.info!=null){l.i=m.info}if(m.show){j.a.push(l)}});if(i.show){g.push(j)}});return g};b.fromCompressed=function(h){var g=[];angular.forEach(h,function(j,i){if(j.c==undefined){j.c=0}if(j.p==undefined){j.p=0}var k={name:j.n,show:true,color:j.c,position:j.p,checked:false,articles:[]};angular.forEach(j.a,function(m,l){if(m.v==undefined){m.v=0}if(m.i==undefined){m.i=null}k.articles.push({name:m.n,show:true,quantite:m.v,info:m.i,checked:false})});g.push(k)});return g};b.selectArticle=function(h,i,g){if(b.listemode=="edit"){if(h.quantite==0){b.addArticle(h,i,1,g)}}else{h.checked=!h.checked;b.checkRayon(i)}g.stopPropagation()};b.checkRayon=function(h,g){if(d("FSelected")(h.articles).length==d("FChecked")(h.articles).length){h.checked=true}else{h.checked=false}};b.addArticle=function(i,j,h,g){i.show=true;i.checked=false;if(h==null){h=+1}i.quantite=i.quantite+h;if(i.quantite<0){i.quantite=0}b.checkRayon(j);g.stopPropagation()};b.addInfoArticle=function(h,g){h.info="";h.checked=false;g.stopPropagation()};b.removeArticle=function(h,g){h.show=false;g.stopPropagation()};b.clearArticle=function(h,g){h.quantite=0;h.info=null;h.checked=false;g.stopPropagation()};b.checkInfo=function(g){if(g.info==""){g.info=null}};b.newArticle=function(g){if(this.articleFilter){aKey=c(g.articles,"name",this.articleFilter);if(false===aKey){g.articles.push({name:this.articleFilter,show:true,quantite:1,info:null,checked:false})}else{b.selectArticle(g.articles[aKey])}this.articleFilter=""}};b.changeColor=function(h,g){h.color=g};b.reOrderRayon=function(g){angular.forEach(b.liste,function(i,h){b.liste[h].position=g.indexOf(i.name)});b.$digest()};b.emptyRayonArticles=function(g){angular.forEach(g.articles,function(i,h){i.info=null;i.quantite=0})};b.removeRayonArticles=function(g){b.emptyRayonArticles(g);angular.forEach(g.articles,function(i,h){i.show=false})};b.removeRayon=function(g){b.removeRayonArticles(g);g.show=false};b.addRayon=function(g){g.show=true};b.newRayon=function(){if(this.rayonFilter){rKey=c(b.liste,"name",this.rayonFilter);if(false===rKey){b.liste.push({name:this.rayonFilter,position:9999,color:0,checked:false,show:true,articles:[]})}else{b.addRayon(b.liste[rKey])}this.rayonFilter=""}};b.save=function(){b.status="enregistrement en cours ...";f.put("./api/liste/",{liste:b.toCompressed(),name:this.listname}).success(function(g){b.currentList=g;if(b.currentList.name==""){b.currentList.name="sans titre"}e.history.pushState(null,null,"./"+b.currentList.slug);b.loaduserlistes();b.savemenu=false;b.status=null;b.savemenu=false}).error(function(g){b.lightbox={title:"erreur",content:g.error};b.status=null})};b.load=function(g){b.status="chargement en cours ...";if(null===g){g="default"}f.get("./api/liste/"+g+".json").success(function(h){b.currentList=h.liste;if(b.currentList.name==""){b.currentList.name="sans titre"}e.history.pushState(null,null,"./"+b.currentList.slug);e.onpopstate=function(i){settimeout(function(){b.load(i.state)},100)};b.page="liste";b.liste=b.fromCompressed(h.content);b.combineData();b.status=null;b.loadmenu=false}).error(function(h){b.lightbox={title:"erreur",content:h.error};b.status=null});return false};b.loaduserlistes=function(){f.get("./api/liste/").success(function(g){b.userlistes=g;angular.forEach(b.userlistes,function(h,i){if(h.name==""){h.name=".sans titre"}})})};b.loadfullliste=function(){f.get("./api/liste/full.json").success(function(g){b.full=g.content;b.combineData()})};b.combineData=function(){if((b.full==undefined)||(b.liste==undefined)){return false}else{angular.forEach(b.full,function(g){rKey=c(b.liste,"name",g.n);if(false===rKey){r={name:g.n,show:false,color:0,articles:[]};b.liste.push(r);rKey=b.liste.length-1}angular.forEach(g.a,function(h){aKey=c(b.liste[rKey].articles,"name",h.n);if(false===aKey){a={name:h.n,show:false,quantite:0,info:null};b.liste[rKey].articles.push(a)}})})}};b.showdata=function(){b.lightbox={title:"data",content:JSON.stringify(b.toCompressed())}};b.print=function(){e.print()};b.loaduserlistes();b.loadfullliste();b.load(b.OpenListe);$(function(){$(".sortable").sortable({axis:"y",distance:5,update:function(g,h){b.reOrderRayon($(this).sortable("toArray",{attribute:"data-name"}))}})})};